# =============================================================================
# CIA DASHBOARD - DEVELOPMENT
# =============================================================================
# Ambiente de desenvolvimento: apenas infraestrutura.
# Apps rodam localmente com `npm run dev`
#
# Uso:
#   npm run docker:up    # Levanta infraestrutura
#   npm run dev          # Roda apps localmente
#
# Portas expostas para localhost (ver .env para valores)
#
# =============================================================================
# REGRA DE OURO: Nenhum valor hardcoded!
# =============================================================================
# - Todos os parâmetros DEVEM ser referências: ${VAR}
# - Valores vão no .env (base) ou .env.{environment} (sobrescritas)
# - Formas permitidas:
#     VAR: ${OUTRA_VAR}
#     VAR: ${OUTRA_VAR}:porta_interna
# - PROIBIDO:
#     VAR: valor_literal
#     VAR: "valor_literal"
# =============================================================================

name: ${PROJECT}-dev

services:
  # ===========================================================================
  # Init - Cria estrutura de pastas (Windows/NTFS compativel)
  # ===========================================================================
  init:
    image: busybox:latest
    container_name: ${PROJECT}-dev-init
    command: |
      sh -c "
        mkdir -p /data/postgres-main /data/postgres-analytics /data/mongo /data/redis /data/meilisearch /data/ollama /data/n8n /data/evolution/instances /data/evolution/store &&
        chmod -R 777 /data &&
        echo 'Init complete'
      "
    volumes:
      - ./data:/data
    restart: "no"

  # ===========================================================================
  # PostgreSQL MAIN (Transacional)
  # ===========================================================================
  postgres-main:
    image: postgres:16-alpine
    container_name: ${PROJECT}-dev-postgres-main
    restart: unless-stopped
    depends_on:
      init:
        condition: service_completed_successfully
    ports:
      - "${POSTGRES_MAIN_PORT}:${POSTGRES_INTERNAL_PORT}"
    environment:
      POSTGRES_USER: ${POSTGRES_MAIN_SUPERUSER}
      POSTGRES_PASSWORD: ${POSTGRES_MAIN_SUPERUSER_PASSWORD}
      POSTGRES_DB: ${POSTGRES_INIT_DB}
    volumes:
      - ./data/postgres-main:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_MAIN_SUPERUSER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      internal:
        aliases:
          - postgres-main.internal

  # ===========================================================================
  # PostgreSQL MAIN Init - Cria user, database, migrations
  # ===========================================================================
  postgres-main-init:
    build:
      context: .
      dockerfile: docker/postgres-main-init/Dockerfile
    image: ${PROJECT}-postgres-main-init:latest
    container_name: ${PROJECT}-dev-postgres-main-init
    depends_on:
      postgres-main:
        condition: service_healthy
    env_file:
      - .env
      - .env.development
      - path: .env.secrets
        required: false
    environment:
      POSTGRES_HOST: ${POSTGRES_MAIN_HOST}
      POSTGRES_PORT: ${POSTGRES_INTERNAL_PORT}
      ENVIRONMENT: ${ENVIRONMENT}
    networks:
      - internal
    restart: "no"

  # ===========================================================================
  # PostgreSQL ANALYTICS (OLAP - Modelo Estrela)
  # ===========================================================================
  postgres-analytics:
    image: postgres:16-alpine
    container_name: ${PROJECT}-dev-postgres-analytics
    restart: unless-stopped
    depends_on:
      init:
        condition: service_completed_successfully
    ports:
      - "${POSTGRES_ANALYTICS_PORT}:${POSTGRES_INTERNAL_PORT}"
    environment:
      POSTGRES_USER: ${POSTGRES_ANALYTICS_SUPERUSER}
      POSTGRES_PASSWORD: ${POSTGRES_ANALYTICS_SUPERUSER_PASSWORD}
      POSTGRES_DB: ${POSTGRES_INIT_DB}
    volumes:
      - ./data/postgres-analytics:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_ANALYTICS_SUPERUSER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      internal:
        aliases:
          - postgres-analytics.internal

  # ===========================================================================
  # PostgreSQL ANALYTICS Init - Cria user, database, migrations
  # ===========================================================================
  postgres-analytics-init:
    build:
      context: .
      dockerfile: docker/postgres-analytics-init/Dockerfile
    image: ${PROJECT}-postgres-analytics-init:latest
    container_name: ${PROJECT}-dev-postgres-analytics-init
    depends_on:
      postgres-analytics:
        condition: service_healthy
    env_file:
      - .env
      - .env.development
      - path: .env.secrets
        required: false
    environment:
      POSTGRES_HOST: ${POSTGRES_ANALYTICS_HOST}
      POSTGRES_PORT: ${POSTGRES_INTERNAL_PORT}
      ENVIRONMENT: ${ENVIRONMENT}
    networks:
      - internal
    restart: "no"

  # ===========================================================================
  # MongoDB (Documentos, Logs, Analytics)
  # ===========================================================================
  mongo:
    image: mongo:7
    container_name: ${PROJECT}-dev-mongo
    restart: unless-stopped
    depends_on:
      init:
        condition: service_completed_successfully
    ports:
      - "${MONGO_PORT}:${MONGO_INTERNAL_PORT}"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    volumes:
      - ./data/mongo:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      internal:
        aliases:
          - mongo.internal

  # ===========================================================================
  # Redis (Cache, Sessions, Queue)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: ${PROJECT}-dev-redis
    restart: unless-stopped
    depends_on:
      init:
        condition: service_completed_successfully
    ports:
      - "${REDIS_PORT}:${REDIS_INTERNAL_PORT}"
    volumes:
      - ./data/redis:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      internal:
        aliases:
          - redis.internal

  # ===========================================================================
  # Meilisearch (Full-text Search)
  # ===========================================================================
  meilisearch:
    image: getmeili/meilisearch:v1.6
    container_name: ${PROJECT}-dev-meilisearch
    restart: unless-stopped
    depends_on:
      init:
        condition: service_completed_successfully
    ports:
      - "${MEILISEARCH_PORT}:${MEILISEARCH_INTERNAL_PORT}"
    environment:
      MEILI_ENV: ${MEILI_ENV}
      MEILI_NO_ANALYTICS: ${MEILI_NO_ANALYTICS}
    volumes:
      - ./data/meilisearch:/meili_data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      internal:
        aliases:
          - meilisearch.internal

  # ===========================================================================
  # Ollama (Local LLM Runner)
  # ===========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: ${PROJECT}-dev-ollama
    restart: unless-stopped
    depends_on:
      init:
        condition: service_completed_successfully
    ports:
      - "${OLLAMA_PORT}:${OLLAMA_INTERNAL_PORT}"
    volumes:
      - ./data/ollama:/root/.ollama
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:11434/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      internal:
        aliases:
          - ollama.internal

  # ===========================================================================
  # Ollama Init - Pull de modelos configurados
  # ===========================================================================
  ollama-init:
    build:
      context: .
      dockerfile: docker/ollama-init/Dockerfile
    image: ${PROJECT}-ollama-init:latest
    container_name: ${PROJECT}-dev-ollama-init
    depends_on:
      ollama:
        condition: service_healthy
    env_file:
      - .env
      - .env.development
      - path: .env.secrets
        required: false
    environment:
      OLLAMA_HOST: ${OLLAMA_HOST}
      OLLAMA_PORT: ${OLLAMA_INTERNAL_PORT}
    networks:
      - internal
    restart: "no"

  # ===========================================================================
  # Evolution API (WhatsApp)
  # ===========================================================================
  evolution:
    image: evoapicloud/evolution-api:v2.3.7
    container_name: ${PROJECT}-dev-evolution
    restart: unless-stopped
    depends_on:
      postgres-main-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    ports:
      - "${EVOLUTION_PORT}:${EVOLUTION_INTERNAL_PORT}"
    environment:
      DATABASE_PROVIDER: ${EVOLUTION_DATABASE_PROVIDER}
      DATABASE_CONNECTION_URI: postgresql://${POSTGRES_MAIN_USER}:${POSTGRES_MAIN_PASSWORD}@${POSTGRES_MAIN_HOST}:${POSTGRES_INTERNAL_PORT}/${EVOLUTION_DB}
      CACHE_REDIS_ENABLED: ${EVOLUTION_CACHE_REDIS_ENABLED}
      CACHE_REDIS_URI: ${REDIS_URL}
      RABBITMQ_ENABLED: ${EVOLUTION_RABBITMQ_ENABLED}
      AUTHENTICATION_API_KEY: ${EVOLUTION_API_KEY}
    volumes:
      - ./data/evolution/instances:/evolution/instances
      - ./data/evolution/store:/evolution/store
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      internal:
        aliases:
          - evolution.internal

  # ===========================================================================
  # Evolution Init - Configura instancia e webhook
  # ===========================================================================
  evolution-init:
    build:
      context: .
      dockerfile: docker/evolution-init/Dockerfile
    image: ${PROJECT}-evolution-init:latest
    container_name: ${PROJECT}-dev-evolution-init
    depends_on:
      evolution:
        condition: service_healthy
    env_file:
      - .env
      - .env.development
      - path: .env.secrets
        required: false
    environment:
      EVOLUTION_HOST: ${EVOLUTION_HOST}
      EVOLUTION_PORT: ${EVOLUTION_INTERNAL_PORT}
      BACKBONE_WEBHOOK_URL: http://host.docker.internal:${BACKBONE_PORT}/webhook/message-received
    networks:
      - internal
    restart: "no"

  # ===========================================================================
  # n8n (Workflow Automation)
  # ===========================================================================
  n8n:
    image: n8nio/n8n:latest
    container_name: ${PROJECT}-dev-n8n
    restart: unless-stopped
    depends_on:
      postgres-main-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    env_file:
      - .env
      - .env.development
      - path: .env.secrets
        required: false
    environment:
      N8N_HOST: ${N8N_HOST}
      N8N_PORT: ${N8N_INTERNAL_PORT}
      N8N_PROTOCOL: ${N8N_PROTOCOL}
      GENERIC_TIMEZONE: ${TZ}
      DB_TYPE: ${N8N_DB_TYPE}
      DB_POSTGRESDB_HOST: ${POSTGRES_MAIN_HOST}
      DB_POSTGRESDB_PORT: ${POSTGRES_INTERNAL_PORT}
      DB_POSTGRESDB_DATABASE: ${POSTGRES_MAIN_DB}
      DB_POSTGRESDB_SCHEMA: ${N8N_DB_SCHEMA}
      DB_POSTGRESDB_USER: ${POSTGRES_MAIN_USER}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_MAIN_PASSWORD}
      NODE_FUNCTION_ALLOW_EXTERNAL: ${N8N_FUNCTION_ALLOW_EXTERNAL}
      NODE_FUNCTION_ALLOW_BUILTIN: ${N8N_FUNCTION_ALLOW_BUILTIN}
      N8N_BLOCK_ENV_ACCESS_IN_NODE: ${N8N_BLOCK_ENV_ACCESS}
      REDIS_URL: ${REDIS_URL}
      EVOLUTION_API_URL: ${EVOLUTION_API_URL}
      PORTAL_URL: http://host.docker.internal:${PORT}
    ports:
      - "${N8N_PORT}:${N8N_INTERNAL_PORT}"
    volumes:
      - ./data/n8n:/home/node/.n8n
      - ./workflows:/home/node/workflows:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      internal:
        aliases:
          - n8n.internal

  # ===========================================================================
  # n8n Init - Importa workflows automaticamente
  # ===========================================================================
  n8n-init:
    image: node:18-alpine
    container_name: ${PROJECT}-dev-n8n-init
    depends_on:
      n8n:
        condition: service_healthy
    volumes:
      - ./scripts/init-n8n.mjs:/app/init-n8n.mjs:ro
      - ./workflows:/app/workflows:ro
    env_file:
      - .env
      - .env.development
      - path: .env.secrets
        required: false
    environment:
      N8N_HOST: ${N8N_HOST}
      N8N_PORT: ${N8N_INTERNAL_PORT}
      WORKFLOWS_DIR: ${N8N_WORKFLOWS_DIR}
    working_dir: /app
    command: node init-n8n.mjs
    networks:
      - internal
    restart: "no"

  # ===========================================================================
  # Adminer (Database GUI)
  # ===========================================================================
  adminer:
    image: adminer:latest
    container_name: ${PROJECT}-dev-adminer
    restart: unless-stopped
    ports:
      - "${ADMINER_PORT}:${ADMINER_INTERNAL_PORT}"
    depends_on:
      postgres-main:
        condition: service_healthy
      postgres-analytics:
        condition: service_healthy
    environment:
      ADMINER_DEFAULT_SERVER: ${ADMINER_DEFAULT_SERVER}
    networks:
      internal:
        aliases:
          - adminer.internal

networks:
  internal:
    driver: bridge
